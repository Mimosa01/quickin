var A=Object.defineProperty;var E=(o,e,t)=>e in o?A(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var s=(o,e,t)=>E(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();class L{constructor(e,t){s(this,"shapeType");s(this,"params");this.shapeType=e,this.params=t}}class N{constructor(e){s(this,"shapeManager");this.shapeManager=e}execute(e){const t=this.shapeManager.getAllShapes(),n=Math.max(0,...t.map(i=>i.zIndex??0)),r={...e.params,zIndex:n+1};this.shapeManager.addShape(e.shapeType,r)}}class T{constructor(){s(this,"handlers",new Map)}register(e,t){this.handlers.set(e,t)}execute(e){const t=this.handlers.get(e.constructor.name);if(t)try{t.execute(e)}catch(n){console.error(`Error while executing command ${e.constructor.name}:`,n)}else console.warn(`No handler registered for command: ${e.constructor.name}`)}}class _{constructor(){s(this,"listeners",{})}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==t))}emit(e,t){for(const n of this.listeners[e])try{n(t)}catch(r){console.error(`Error in listener for event "${String(e)}":`,r)}}}class R{constructor(e){s(this,"shapeManager");this.shapeManager=e}execute(e){const{to:t}=e,n=this.shapeManager.getType();if(n==="NullShape")return;const r=this.shapeManager.getSetters(n);r.position.x(t.x),r.position.y(t.y)}}class k{constructor(e){s(this,"shapeManager");this.shapeManager=e}execute(e){this.shapeManager.select(e.shapeId)}}class m{constructor(e="div"){s(this,"element");this.element=document.createElement(e)}render(e){this.element&&e.append(this.element)}destroy(){this.element.remove()}}class ${constructor({labelText:e,type:t="number",value:n,onChange:r}){s(this,"span");s(this,"input");s(this,"component");s(this,"onChange");this.component=new m("label"),this.span=document.createElement("span"),this.input=document.createElement("input"),this.onChange=r,this.span.textContent=e,this.component.element.setAttribute("for",e),this.input.setAttribute("id",e),this.input.setAttribute("type",t),this.input.setAttribute("value",n),this.component.element.classList.add("inspector__label"),this.span.classList.add("inspector__label__span"),this.input.classList.add("inspector__input"),this.component.element.append(this.span),this.component.element.append(this.input),this.input.addEventListener("blur",i=>{let h=i.target.value;t==="number"&&(h=Number(h),isNaN(h))||this.onChange(h.toString())})}getComponent(){return this.component}updateValue(e){const t=this.input;t.value!==e&&(t.value=e)}}class U{constructor(e="row"){s(this,"component");this.component=new m,this.component.element.classList.add("inspector__wrapper",`inspector__wrapper--${e}`)}getComponent(){return this.component}}class x{constructor(e="header"){s(this,"span");s(this,"component");this.component=new m,this.span=document.createElement("span"),this.span.textContent=e,this.component.element.classList.add("inspector__section","p-inner"),this.span.classList.add("inspector__header"),this.component.element.append(this.span)}getComponent(){return this.component}}class H{constructor({shapeManager:e,eventBus:t,container:n}){s(this,"shapeManager");s(this,"eventBus");s(this,"container");s(this,"fields",new Map);this.shapeManager=e,this.eventBus=t,this.container=n,this.eventBus.on("shape:selected",()=>{this.render()}),this.eventBus.on("shape:updated",({id:r})=>{r===this.shapeManager.getCurrentId()&&this.updateInputs()}),this.render()}render(){const e=this.shapeManager.getType(),t=this.shapeManager.getProperties(e),n=this.shapeManager.getSetters(e);this.container.innerHTML="";const r=new x(t.general.name);Object.entries(t).forEach(([i,a])=>{if(i!=="general"){const h=new x(i),p=new U("column");Object.entries(a).forEach(([u,y])=>{const f=u,M=n[i][f];if(typeof M=="function"){const b=new $({labelText:u[0].toUpperCase(),value:String(y),type:"text",onChange:I=>M(I)}),B=`${i}.${u}`;this.fields.set(B,b),b.getComponent().render(p.getComponent().element)}}),p.getComponent().render(h.getComponent().element),h.getComponent().render(r.getComponent().element)}}),r.getComponent().render(this.container)}updateInputs(){const e=this.shapeManager.getType(),t=this.shapeManager.getProperties(e);for(const[n,r]of Object.entries(t))for(const[i,a]of Object.entries(r)){const h=`${n}.${i}`,p=this.fields.get(h);p&&p.updateValue(String(a))}}}class O{constructor(){s(this,"toolType","idle");s(this,"toolMode","idle");s(this,"pendingMoveStart",!1)}setTool(e){this.toolType=e}setMode(e){this.toolMode=e}getTool(){return this.toolType}getMode(){return this.toolMode}clearTool(){this.toolType="select"}clearMode(){this.toolMode="idle"}setPendingMoveStart(e){this.pendingMoveStart=e}getPendingMoveStart(){return this.pendingMoveStart}clearPendingMoveStart(){this.pendingMoveStart=!1}}const c=new O;class C{constructor(e){s(this,"shapeId");this.shapeId=e,c.setTool("select")}}class F{constructor({name:e,id:t,onSelect:n}){s(this,"id");s(this,"component");s(this,"button");s(this,"onSelect");this.component=new m("li"),this.id=t,this.onSelect=n,this.component.element.classList.add("list-objects__item"),this.component.element.setAttribute("data-id",t),this.button=document.createElement("button"),this.button.classList.add("btn-reset"),this.button.textContent=e,this.component.element.append(this.button),this.addEventListeners()}addEventListeners(){this.component.element.addEventListener("click",()=>this.onSelect(this.id))}setSelected(e){this.component.element.classList.toggle("select-item",e)}getComponent(){return this.component}}class z{constructor({onSelect:e}){s(this,"children",new Map);s(this,"onSelect");s(this,"component");this.component=new m("ul"),this.onSelect=e,this.component.element.classList.add("list-reset","list-objects")}addItem({name:e,id:t}){const n=new F({name:e,id:t,onSelect:this.onSelect});this.children.set(t,n),n.getComponent().render(this.component.element)}removeItem(e){var t;(t=this.children.get(e))==null||t.getComponent().destroy(),this.children.delete(e)}selectItem(e){this.children.forEach(t=>{t.setSelected(t.id===e)})}getComponent(){return this.component}}class j{constructor(e,t,n){s(this,"container");s(this,"mainList");s(this,"commandBus");s(this,"eventBus");this.container=e,this.commandBus=t,this.eventBus=n,this.mainList=new z({onSelect:r=>{this.commandBus.execute(new C(r))}}),this.eventBus.on("shape:selected",({id:r})=>{this.mainList.selectItem(r)}),this.eventBus.on("shape:created",({id:r,name:i})=>{this.addItem({id:r,name:i})}),this.mainList.getComponent().render(this.container)}addItem({name:e,id:t}){this.mainList.addItem({name:e,id:t})}removeItem(e){this.mainList.removeItem(e)}}class W{constructor(){s(this,"name","NullShape");s(this,"id","0");s(this,"type","NullShape");s(this,"zIndex",-1)}}class V{constructor({x:e=100,y:t=100,width:n=100,height:r=100,fill:i="#000000",cornerRadius:a=0,zIndex:h=1,name:p="Untitled"}={}){s(this,"x");s(this,"y");s(this,"width");s(this,"height");s(this,"fill");s(this,"cornerRadius");s(this,"name");s(this,"zIndex");s(this,"id");s(this,"type","Rectangle");this.x=e,this.y=t,this.width=n,this.height=r,this.fill=i,this.cornerRadius=a,this.id=crypto.randomUUID(),this.name=p,this.zIndex=h}}class D{getProperties(){return{general:{id:"0",name:"NullShape",type:"NullShape",zIndex:-1}}}getSetters(){return{}}}class q{constructor(e){s(this,"shape");this.shape=e}getProperties(){return{general:{name:this.shape.name,id:this.shape.id,type:this.shape.type,zIndex:this.shape.zIndex},position:{x:this.shape.x,y:this.shape.y},transform:{width:this.shape.width,height:this.shape.height,cornerRadius:this.shape.cornerRadius},fill:{fill:this.shape.fill}}}getSetters(){return{general:{name:e=>this.shape.name=e},position:{x:e=>{this.shape.x=e},y:e=>this.shape.y=e},transform:{width:e=>this.shape.width=e,height:e=>this.shape.height=e,cornerRadius:e=>this.shape.cornerRadius=e},fill:{fill:e=>{if(e[0]!=="#")throw new Error("Цвет должен быть задан в формате #HEX");this.shape.fill=e}}}}}const g={Rectangle:{shape:V,strategyFactory:o=>new q(o),props:{},setters:{}},NullShape:{shape:W,strategyFactory:()=>new D,props:{},setters:{}}};function P(o){const e=g[o.type];if(!e)throw new Error(`No strategy found for type: ${o.type}`);return e.strategyFactory(o)}class X{constructor(e){s(this,"nameCounters",new Map);s(this,"eventBus");s(this,"selectedShape");s(this,"strategy");s(this,"shapes",new Map);s(this,"nullShape",new g.NullShape.shape);this.eventBus=e,this.selectedShape=this.nullShape,this.strategy=g.NullShape.strategyFactory(),this.eventBus.on("shapeManager:selected",({id:t})=>{this.select(t)})}addShape(e,t){const n=g[e];if(!n)throw new Error(`Unknown shape type: ${e}`);const r=this.generateName(e),i=new n.shape({...t,name:r,type:e});this.shapes.set(i.id,i),this.selectedShape=i,this.strategy=P(i),this.eventBus.emit("shape:created",{id:this.selectedShape.id,name:this.selectedShape.name}),this.eventBus.emit("shape:selected",{id:this.selectedShape.id})}removeShape(e){this.shapes.delete(e)}select(e){const t=this.shapes.get(e);if(!t)return this.unselect();this.selectedShape=t,this.strategy=P(this.selectedShape),this.eventBus.emit("shape:selected",{id:this.selectedShape.id})}unselect(){this.selectedShape=this.nullShape,this.strategy=g.NullShape.strategyFactory(),this.eventBus.emit("shape:selected",this.nullShape)}getProperties(e){return this.strategy.getProperties()}getSetters(e){return this.strategy.getSetters()}getAllShapes(){return Array.from(this.shapes.values())}getType(){return this.selectedShape.type}getCurrentId(){return this.selectedShape.id}getShapePosition(){if(this.selectedShape.type==="NullShape")throw new Error("No shape selected");return{x:this.getProperties(this.selectedShape.type).position.x,y:this.getProperties(this.selectedShape.type).position.y}}generateName(e){const n=(this.nameCounters.get(e)||0)+1;return this.nameCounters.set(e,n),`${e} ${n}`}}class Z{constructor({from:e,to:t}){s(this,"from");s(this,"to");this.from=e,this.to=t}}class G{constructor(e,t,n){s(this,"commandBus");s(this,"eventBus");s(this,"getShapePosition");s(this,"currentShapeId","");s(this,"currentPos",{x:0,y:0});s(this,"offsetPos",{x:0,y:0});this.commandBus=e,this.eventBus=t,this.getShapePosition=n,this.eventBus.on("shape:created",({id:r})=>{this.currentShapeId=r,c.setTool("select"),this.offsetPos={x:0,y:0}}),this.eventBus.on("shape:selected",({id:r})=>{if(this.currentShapeId=r,c.setTool("select"),c.getPendingMoveStart()){const i=this.getShapePosition();this.offsetPos={x:this.currentPos.x-i.x,y:this.currentPos.y-i.y},c.setMode("move"),c.clearPendingMoveStart()}else this.offsetPos={x:0,y:0}})}onPointerDown(e){var h,p;const t=c.getTool(),n=e.target,r=(h=n==null?void 0:n.dataset)==null?void 0:h.id,i=(p=n==null?void 0:n.dataset)==null?void 0:p.role,a=this.getMouseSvgCoords(e);switch(t){case"rectangle":const u=Math.round(a.x-50),y=Math.round(a.y-50);this.commandBus.execute(new L("Rectangle",{width:100,height:100,x:u,y}));break;case"idle":case"select":if(r){const f=r===this.currentShapeId;if(this.currentPos=a,!f){c.setPendingMoveStart(!0),this.commandBus.execute(new C(r));return}if(i==="body"){const w=this.getShapePosition();this.offsetPos={x:a.x-w.x,y:a.y-w.y},c.setMode("move")}}else c.setTool("idle"),c.setMode("idle"),this.currentShapeId="";break}}onPointerMove(e){if(c.getMode()!=="move")return;const t=this.getMouseSvgCoords(e),n={x:Math.round(t.x-this.offsetPos.x),y:Math.round(t.y-this.offsetPos.y)},r=Math.round(n.x-this.currentPos.x),i=Math.round(n.y-this.currentPos.y);(r!==0||i!==0)&&(this.commandBus.execute(new Z({from:this.currentPos,to:n})),this.currentPos=n,this.eventBus.emit("shape:updated",{id:this.currentShapeId}))}onPointerUp(){c.setMode("idle"),c.clearPendingMoveStart()}getMouseSvgCoords(e){const t=document.querySelector("svg"),n=t.createSVGPoint();n.x=e.clientX,n.y=e.clientY;const r=n.matrixTransform(t.getScreenCTM().inverse());return{x:r.x,y:r.y}}getSceneHandlers(){return new Map([["pointerdown",this.onPointerDown.bind(this)],["pointermove",this.onPointerMove.bind(this)],["pointerup",this.onPointerUp.bind(this)]])}}class Y{constructor(e){s(this,"element");s(this,"props");this.props=e,this.element=this.createElement()}createElement(){const e=document.createElementNS("http://www.w3.org/2000/svg","rect");return this.updateAttributes(e),e.dataset.id=this.props.general.id,e}updateAttributes(e){const{x:t,y:n}=this.props.position,{width:r,height:i,cornerRadius:a}=this.props.transform,{fill:h}=this.props.fill,{id:p}=this.props.general;e.setAttribute("x",t.toString()),e.setAttribute("y",n.toString()),e.setAttribute("width",r.toString()),e.setAttribute("height",i.toString()),e.setAttribute("fill",h),e.setAttribute("rx",a.toString()),e.setAttribute("data-id",p)}update(e){this.props=e,this.updateAttributes(this.element)}}class J{static create(e){switch(e.general.type){case"Rectangle":return new Y(e);default:throw new Error(`Unknown shape type: ${e.general.type}`)}}}class Q{constructor(){s(this,"strokeWidth",2);s(this,"strokeColor","#ff0000")}hitBoxRectangle(e){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("data-role","hitbox"),t.setAttribute("data-id",e.general.id);const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",e.position.x.toString()),n.setAttribute("y",e.position.y.toString()),n.setAttribute("width",e.transform.width.toString()),n.setAttribute("height",e.transform.height.toString()),n.setAttribute("fill","transparent"),n.setAttribute("stroke",this.strokeColor),n.setAttribute("stroke-width",this.strokeWidth.toString()),n.setAttribute("data-role","body"),n.setAttribute("data-id",e.general.id);const r=document.createElementNS("http://www.w3.org/2000/svg","rect");return r.setAttribute("x",(e.position.x-4).toString()),r.setAttribute("y",(e.position.y-4).toString()),r.setAttribute("width",(e.transform.width+8).toString()),r.setAttribute("height",(e.transform.height+8).toString()),r.setAttribute("fill","transparent"),r.setAttribute("stroke",this.strokeColor),r.setAttribute("stroke-dasharray","4"),r.setAttribute("data-role","border"),r.setAttribute("data-id",e.general.id),t.appendChild(r),t.appendChild(n),t}}class K{constructor({eventBus:e,shapeManager:t,viewport:n}){s(this,"currentSelection",null);s(this,"ui",new Q);s(this,"eventBus");s(this,"shapeManager");s(this,"viewport");this.eventBus=e,this.shapeManager=t,this.viewport=n,this.eventBus.on("shape:selected",()=>{this.selectShape()})}selectShape(){this.clear();const e=this.shapeManager.getType();switch(e){case"Rectangle":const t=this.shapeManager.getProperties(e),n=this.ui.hitBoxRectangle(t);this.viewport.append(n),this.currentSelection=n;break}}clear(){var e;(e=this.currentSelection)!=null&&e.parentNode&&this.currentSelection.parentNode.removeChild(this.currentSelection),this.currentSelection=null}updateUI(){this.selectShape()}}class ee{constructor({container:e,handlers:t,eventBus:n,shapeManager:r}){s(this,"container");s(this,"scene");s(this,"viewport");s(this,"handlers");s(this,"eventBus");s(this,"shapeManager");s(this,"shapes",new Map);s(this,"hitBox");this.shapeManager=r,this.eventBus=n,this.handlers=t,this.container=e,this.scene=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.viewport=document.createElementNS("http://www.w3.org/2000/svg","g"),this.hitBox=new K({eventBus:n,shapeManager:r,viewport:this.viewport}),this.scene.setAttribute("width","100%"),this.scene.setAttribute("height","100%"),this.scene.style.userSelect="none",this.scene.append(this.viewport),this.container.appendChild(this.scene),this.eventBus.on("shape:created",()=>{const i=this.shapeManager.getType(),a=this.shapeManager.getProperties(i),h=J.create(a);this.shapes.set(a.general.id,h),this.viewport.append(h.element)}),this.handlers.getSceneHandlers().forEach((i,a)=>{this.scene.addEventListener(a,h=>i(h))}),this.eventBus.on("shape:updated",({id:i})=>{const a=this.shapes.get(i),h=this.shapeManager.getType();a==null||a.update(r.getProperties(h)),this.hitBox.updateUI()})}}const te=document.getElementById("layers"),se=document.getElementById("inspector"),v=document.getElementById("rectButton"),ne=document.getElementById("scene"),S=new _,d=new T,l=new X(S),re=new G(d,S,l.getShapePosition.bind(l));new j(te,d,S);new H({shapeManager:l,eventBus:S,container:se});new ee({container:ne,handlers:re,eventBus:S,shapeManager:l,commandBus:d});d.register("SelectCommand",new k(l));d.register("AddShapeCommand",new N(l));d.register("MoveCommand",new R(l));v==null||v.addEventListener("click",()=>{c.setTool("rectangle")});
