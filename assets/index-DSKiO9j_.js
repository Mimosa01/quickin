var L=Object.defineProperty;var N=(o,e,t)=>e in o?L(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var s=(o,e,t)=>N(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class b{constructor(e,t){s(this,"shapeType");s(this,"params");this.shapeType=e,this.params=t}}s(b,"type","AddShapeCommand");class T{constructor(e){s(this,"shapeManager");this.shapeManager=e}execute(e){const t=this.shapeManager.getAllShapes(),n=Math.max(0,...t.map(r=>r.zIndex??0)),i={...e.params,zIndex:n+1};this.shapeManager.addShape(e.shapeType,i)}}class _{constructor(){s(this,"handlers",new Map)}register(e,t){this.handlers.set(e,t)}execute(e){const t=e.constructor.type,n=this.handlers.get(t);if(n)try{n.execute(e)}catch(i){console.error(`Error while executing command ${e.constructor.name}:`,i)}else console.warn(`No handler registered for command: ${e.constructor.name}`)}}class R{constructor(){s(this,"listeners",{})}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==t))}emit(e,t){for(const n of this.listeners[e])try{n(t)}catch(i){console.error(`Error in listener for event "${String(e)}":`,i)}}}class x{constructor({from:e,to:t}){s(this,"from");s(this,"to");this.from=e,this.to=t}}s(x,"type","MoveCommand");class k{constructor(e){s(this,"shapeManager");this.shapeManager=e}execute(e){const{to:t}=e,n=this.shapeManager.getType();if(n==="NullShape")return;const i=this.shapeManager.getSetters(n);i.position.x(t.x),i.position.y(t.y)}}class ${constructor(){s(this,"toolType","idle");s(this,"toolMode","idle");s(this,"pendingMoveStart",!1)}setTool(e){this.toolType=e}setMode(e){this.toolMode=e}getTool(){return this.toolType}getMode(){return this.toolMode}clearTool(){this.toolType="select"}clearMode(){this.toolMode="idle"}setPendingMoveStart(e){this.pendingMoveStart=e}getPendingMoveStart(){return this.pendingMoveStart}clearPendingMoveStart(){this.pendingMoveStart=!1}}const c=new $;class y{constructor(e){s(this,"shapeId");this.shapeId=e,c.setTool("select")}}s(y,"type","SelectCommand");class U{constructor(e){s(this,"shapeManager");this.shapeManager=e}execute(e){this.shapeManager.select(e.shapeId)}}class m{constructor(e="div"){s(this,"element");this.element=document.createElement(e)}render(e){this.element&&e.append(this.element)}destroy(){this.element.remove()}}class H{constructor({labelText:e,type:t="number",value:n,onChange:i}){s(this,"span");s(this,"input");s(this,"component");s(this,"onChange");this.component=new m("label"),this.span=document.createElement("span"),this.input=document.createElement("input"),this.onChange=i,this.span.textContent=e,this.component.element.setAttribute("for",e),this.input.setAttribute("id",e),this.input.setAttribute("type",t),this.input.setAttribute("value",n),this.component.element.classList.add("inspector__label"),this.span.classList.add("inspector__label__span"),this.input.classList.add("inspector__input"),this.component.element.append(this.span),this.component.element.append(this.input),this.input.addEventListener("blur",r=>{let h=r.target.value;t==="number"&&(h=Number(h),isNaN(h))||this.onChange(h.toString())})}getComponent(){return this.component}updateValue(e){const t=this.input;t.value!==e&&(t.value=e)}}class O{constructor(e="row"){s(this,"component");this.component=new m,this.component.element.classList.add("inspector__wrapper",`inspector__wrapper--${e}`)}getComponent(){return this.component}}class I{constructor(e="header"){s(this,"span");s(this,"component");this.component=new m,this.span=document.createElement("span"),this.span.textContent=e,this.component.element.classList.add("inspector__section","p-inner"),this.span.classList.add("inspector__header"),this.component.element.append(this.span)}getComponent(){return this.component}}class F{constructor({shapeManager:e,eventBus:t,container:n}){s(this,"shapeManager");s(this,"eventBus");s(this,"container");s(this,"fields",new Map);this.shapeManager=e,this.eventBus=t,this.container=n,this.eventBus.on("shape:selected",()=>{this.render()}),this.eventBus.on("shape:updated",({id:i})=>{i===this.shapeManager.getCurrentId()&&this.updateInputs()}),this.render()}render(){const e=this.shapeManager.getType(),t=this.shapeManager.getProperties(e),n=this.shapeManager.getSetters(e);this.container.innerHTML="";const i=new I(t.general.name);Object.entries(t).forEach(([r,a])=>{if(r!=="general"){const h=new I(r),p=new O("column");Object.entries(a).forEach(([u,f])=>{const w=u,P=n[r][w];if(typeof P=="function"){const B=new H({labelText:u[0].toUpperCase(),value:String(f),type:"text",onChange:E=>P(E)}),A=`${r}.${u}`;this.fields.set(A,B),B.getComponent().render(p.getComponent().element)}}),p.getComponent().render(h.getComponent().element),h.getComponent().render(i.getComponent().element)}}),i.getComponent().render(this.container)}updateInputs(){const e=this.shapeManager.getType(),t=this.shapeManager.getProperties(e);for(const[n,i]of Object.entries(t))for(const[r,a]of Object.entries(i)){const h=`${n}.${r}`,p=this.fields.get(h);p&&p.updateValue(String(a))}}}class z{constructor({name:e,id:t,onSelect:n}){s(this,"id");s(this,"component");s(this,"button");s(this,"onSelect");this.component=new m("li"),this.id=t,this.onSelect=n,this.component.element.classList.add("list-objects__item"),this.component.element.setAttribute("data-id",t),this.button=document.createElement("button"),this.button.classList.add("btn-reset"),this.button.textContent=e,this.component.element.append(this.button),this.addEventListeners()}addEventListeners(){this.component.element.addEventListener("click",()=>this.onSelect(this.id))}setSelected(e){this.component.element.classList.toggle("select-item",e)}getComponent(){return this.component}}class j{constructor({onSelect:e}){s(this,"children",new Map);s(this,"onSelect");s(this,"component");this.component=new m("ul"),this.onSelect=e,this.component.element.classList.add("list-reset","list-objects")}addItem({name:e,id:t}){const n=new z({name:e,id:t,onSelect:this.onSelect});this.children.set(t,n),n.getComponent().render(this.component.element)}removeItem(e){var t;(t=this.children.get(e))==null||t.getComponent().destroy(),this.children.delete(e)}selectItem(e){this.children.forEach(t=>{t.setSelected(t.id===e)})}getComponent(){return this.component}}class W{constructor(e,t,n){s(this,"container");s(this,"mainList");s(this,"commandBus");s(this,"eventBus");this.container=e,this.commandBus=t,this.eventBus=n,this.mainList=new j({onSelect:i=>{this.commandBus.execute(new y(i))}}),this.eventBus.on("shape:selected",({id:i})=>{this.mainList.selectItem(i)}),this.eventBus.on("shape:created",({id:i,name:r})=>{this.addItem({id:i,name:r})}),this.mainList.getComponent().render(this.container)}addItem({name:e,id:t}){this.mainList.addItem({name:e,id:t})}removeItem(e){this.mainList.removeItem(e)}}class V{constructor(){s(this,"name","NullShape");s(this,"id","0");s(this,"type","NullShape");s(this,"zIndex",-1)}}class D{constructor({x:e=100,y:t=100,width:n=100,height:i=100,fill:r="#000000",cornerRadius:a=0,zIndex:h=1,name:p="Untitled"}={}){s(this,"x");s(this,"y");s(this,"width");s(this,"height");s(this,"fill");s(this,"cornerRadius");s(this,"name");s(this,"zIndex");s(this,"id");s(this,"type","Rectangle");this.x=e,this.y=t,this.width=n,this.height=i,this.fill=r,this.cornerRadius=a,this.id=crypto.randomUUID(),this.name=p,this.zIndex=h}}class q{getProperties(){return{general:{id:"0",name:"NullShape",type:"NullShape",zIndex:-1}}}getSetters(){return{}}}class X{constructor(e){s(this,"shape");this.shape=e}getProperties(){return{general:{name:this.shape.name,id:this.shape.id,type:this.shape.type,zIndex:this.shape.zIndex},position:{x:this.shape.x,y:this.shape.y},transform:{width:this.shape.width,height:this.shape.height,cornerRadius:this.shape.cornerRadius},fill:{fill:this.shape.fill}}}getSetters(){return{general:{name:e=>this.shape.name=e},position:{x:e=>{this.shape.x=e},y:e=>this.shape.y=e},transform:{width:e=>this.shape.width=e,height:e=>this.shape.height=e,cornerRadius:e=>this.shape.cornerRadius=e},fill:{fill:e=>{if(e[0]!=="#")throw new Error("Цвет должен быть задан в формате #HEX");this.shape.fill=e}}}}}const g={Rectangle:{shape:D,strategyFactory:o=>new X(o),props:{},setters:{}},NullShape:{shape:V,strategyFactory:()=>new q,props:{},setters:{}}};function C(o){const e=g[o.type];if(!e)throw new Error(`No strategy found for type: ${o.type}`);return e.strategyFactory(o)}class Z{constructor(e){s(this,"nameCounters",new Map);s(this,"eventBus");s(this,"selectedShape");s(this,"strategy");s(this,"shapes",new Map);s(this,"nullShape",new g.NullShape.shape);this.eventBus=e,this.selectedShape=this.nullShape,this.strategy=g.NullShape.strategyFactory(),this.eventBus.on("shapeManager:selected",({id:t})=>{this.select(t)})}addShape(e,t){const n=g[e];if(!n)throw new Error(`Unknown shape type: ${e}`);const i=this.generateName(e),r=new n.shape({...t,name:i,type:e});this.shapes.set(r.id,r),this.selectedShape=r,this.strategy=C(r),this.eventBus.emit("shape:created",{id:this.selectedShape.id,name:this.selectedShape.name}),this.eventBus.emit("shape:selected",{id:this.selectedShape.id})}removeShape(e){this.shapes.delete(e)}select(e){const t=this.shapes.get(e);if(!t)return this.unselect();this.selectedShape=t,this.strategy=C(this.selectedShape),this.eventBus.emit("shape:selected",{id:this.selectedShape.id})}unselect(){this.selectedShape=this.nullShape,this.strategy=g.NullShape.strategyFactory(),this.eventBus.emit("shape:selected",this.nullShape)}getProperties(e){return this.strategy.getProperties()}getSetters(e){return this.strategy.getSetters()}getAllShapes(){return Array.from(this.shapes.values())}getType(){return this.selectedShape.type}getCurrentId(){return this.selectedShape.id}getShapePosition(){if(this.selectedShape.type==="NullShape")throw new Error("No shape selected");return{x:this.getProperties(this.selectedShape.type).position.x,y:this.getProperties(this.selectedShape.type).position.y}}generateName(e){const n=(this.nameCounters.get(e)||0)+1;return this.nameCounters.set(e,n),`${e} ${n}`}}class G{constructor(e,t,n){s(this,"commandBus");s(this,"eventBus");s(this,"getShapePosition");s(this,"currentShapeId","");s(this,"currentPos",{x:0,y:0});s(this,"offsetPos",{x:0,y:0});this.commandBus=e,this.eventBus=t,this.getShapePosition=n,this.eventBus.on("shape:created",({id:i})=>{this.currentShapeId=i,c.setTool("select"),this.offsetPos={x:0,y:0}}),this.eventBus.on("shape:selected",({id:i})=>{if(this.currentShapeId=i,c.setTool("select"),c.getPendingMoveStart()){const r=this.getShapePosition();this.offsetPos={x:this.currentPos.x-r.x,y:this.currentPos.y-r.y},c.setMode("move"),c.clearPendingMoveStart()}else this.offsetPos={x:0,y:0}})}onPointerDown(e){var h,p;const t=c.getTool(),n=e.target,i=(h=n==null?void 0:n.dataset)==null?void 0:h.id,r=(p=n==null?void 0:n.dataset)==null?void 0:p.role,a=this.getMouseSvgCoords(e);switch(t){case"rectangle":const u=Math.round(a.x-50),f=Math.round(a.y-50);this.commandBus.execute(new b("Rectangle",{width:100,height:100,x:u,y:f}));break;case"idle":case"select":if(i){const w=i===this.currentShapeId;if(this.currentPos=a,!w){c.setPendingMoveStart(!0),this.commandBus.execute(new y(i));return}if(r==="body"){const v=this.getShapePosition();this.offsetPos={x:a.x-v.x,y:a.y-v.y},c.setMode("move")}}else c.setTool("idle"),c.setMode("idle"),this.currentShapeId="";break}}onPointerMove(e){if(c.getMode()!=="move")return;const t=this.getMouseSvgCoords(e),n={x:Math.round(t.x-this.offsetPos.x),y:Math.round(t.y-this.offsetPos.y)},i=Math.round(n.x-this.currentPos.x),r=Math.round(n.y-this.currentPos.y);(i!==0||r!==0)&&(this.commandBus.execute(new x({from:this.currentPos,to:n})),this.currentPos=n,this.eventBus.emit("shape:updated",{id:this.currentShapeId}))}onPointerUp(){c.setMode("idle"),c.clearPendingMoveStart()}getMouseSvgCoords(e){const t=document.querySelector("svg"),n=t.createSVGPoint();n.x=e.clientX,n.y=e.clientY;const i=n.matrixTransform(t.getScreenCTM().inverse());return{x:i.x,y:i.y}}getSceneHandlers(){return new Map([["pointerdown",this.onPointerDown.bind(this)],["pointermove",this.onPointerMove.bind(this)],["pointerup",this.onPointerUp.bind(this)]])}}class Y{constructor(e){s(this,"element");s(this,"props");this.props=e,this.element=this.createElement()}createElement(){const e=document.createElementNS("http://www.w3.org/2000/svg","rect");return this.updateAttributes(e),e.dataset.id=this.props.general.id,e}updateAttributes(e){const{x:t,y:n}=this.props.position,{width:i,height:r,cornerRadius:a}=this.props.transform,{fill:h}=this.props.fill,{id:p}=this.props.general;e.setAttribute("x",t.toString()),e.setAttribute("y",n.toString()),e.setAttribute("width",i.toString()),e.setAttribute("height",r.toString()),e.setAttribute("fill",h),e.setAttribute("rx",a.toString()),e.setAttribute("data-id",p)}update(e){this.props=e,this.updateAttributes(this.element)}}class J{static create(e){switch(e.general.type){case"Rectangle":return new Y(e);default:throw new Error(`Unknown shape type: ${e.general.type}`)}}}class Q{constructor(){s(this,"strokeWidth",2);s(this,"strokeColor","#ff0000")}hitBoxRectangle(e){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("data-role","hitbox"),t.setAttribute("data-id",e.general.id);const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",e.position.x.toString()),n.setAttribute("y",e.position.y.toString()),n.setAttribute("width",e.transform.width.toString()),n.setAttribute("height",e.transform.height.toString()),n.setAttribute("fill","transparent"),n.setAttribute("stroke",this.strokeColor),n.setAttribute("stroke-width",this.strokeWidth.toString()),n.setAttribute("data-role","body"),n.setAttribute("data-id",e.general.id);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.setAttribute("x",(e.position.x-4).toString()),i.setAttribute("y",(e.position.y-4).toString()),i.setAttribute("width",(e.transform.width+8).toString()),i.setAttribute("height",(e.transform.height+8).toString()),i.setAttribute("fill","transparent"),i.setAttribute("stroke",this.strokeColor),i.setAttribute("stroke-dasharray","4"),i.setAttribute("data-role","border"),i.setAttribute("data-id",e.general.id),t.appendChild(i),t.appendChild(n),t}}class K{constructor({eventBus:e,shapeManager:t,viewport:n}){s(this,"currentSelection",null);s(this,"ui",new Q);s(this,"eventBus");s(this,"shapeManager");s(this,"viewport");this.eventBus=e,this.shapeManager=t,this.viewport=n,this.eventBus.on("shape:selected",()=>{this.selectShape()})}selectShape(){this.clear();const e=this.shapeManager.getType();switch(e){case"Rectangle":const t=this.shapeManager.getProperties(e),n=this.ui.hitBoxRectangle(t);this.viewport.append(n),this.currentSelection=n;break}}clear(){var e;(e=this.currentSelection)!=null&&e.parentNode&&this.currentSelection.parentNode.removeChild(this.currentSelection),this.currentSelection=null}updateUI(){this.selectShape()}}class ee{constructor({container:e,handlers:t,eventBus:n,shapeManager:i}){s(this,"container");s(this,"scene");s(this,"viewport");s(this,"handlers");s(this,"eventBus");s(this,"shapeManager");s(this,"shapes",new Map);s(this,"hitBox");this.shapeManager=i,this.eventBus=n,this.handlers=t,this.container=e,this.scene=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.viewport=document.createElementNS("http://www.w3.org/2000/svg","g"),this.hitBox=new K({eventBus:n,shapeManager:i,viewport:this.viewport}),this.scene.setAttribute("width","100%"),this.scene.setAttribute("height","100%"),this.scene.style.userSelect="none",this.scene.append(this.viewport),this.container.appendChild(this.scene),this.eventBus.on("shape:created",()=>{const r=this.shapeManager.getType(),a=this.shapeManager.getProperties(r),h=J.create(a);this.shapes.set(a.general.id,h),this.viewport.append(h.element)}),this.handlers.getSceneHandlers().forEach((r,a)=>{this.scene.addEventListener(a,h=>r(h))}),this.eventBus.on("shape:updated",({id:r})=>{const a=this.shapes.get(r),h=this.shapeManager.getType();a==null||a.update(i.getProperties(h)),this.hitBox.updateUI()})}}const te=document.getElementById("layers"),se=document.getElementById("inspector"),M=document.getElementById("rectButton"),ne=document.getElementById("scene"),S=new R,d=new _,l=new Z(S),ie=new G(d,S,l.getShapePosition.bind(l));new W(te,d,S);new F({shapeManager:l,eventBus:S,container:se});new ee({container:ne,handlers:ie,eventBus:S,shapeManager:l,commandBus:d});d.register(y.type,new U(l));d.register(b.type,new T(l));d.register(x.type,new k(l));M==null||M.addEventListener("click",()=>{c.setTool("rectangle")});
